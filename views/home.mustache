<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Finder</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header>
    <h1>{{#user}} {{user.name}}, {{/user}}v√≠tejte v Book Finder</h1>
    <nav>
      {{#user}}
        <a href="/favorites">Obl√≠ben√© knihy</a>
        <button id="logoutButton" class="logout-link">Odhl√°sit se</button>
      {{/user}}

      {{^user}}
        <a href="/auth/login">P≈ôihl√°sit se</a>
        <a href="/auth/signup">Zaregistrovat se</a>
      {{/user}}
    </nav>
  </header>

  <div class="container">
    <form id="search-container" method="GET" action="/books/search">
    <div class="form-group">
      <input type="text" name="query" placeholder="Vyhledat knihu..." required />
    </div>
      <button type="submit">Hledat</button>
    </form>

    {{#error}}
      <p class="error-message">{{error}}</p>
    {{/error}}

    <div class="book-list">
      {{#books}}
        <div class="book-item">
          <img src="{{thumbnail}}" alt="Book cover" />
          <div class="book-info">
            <h3>{{title}}</h3>
            <p><strong>Autor:</strong> {{author}}</p>
            <p><strong>Vyd√°no:</strong> {{publishedDate}}</p>
            <p class="book-description"><strong>Popis:</strong> {{description}}</p>
            
            {{#user}}
              <span 
    class="favorite-icon" 
    data-title="{{title}}" 
    data-author="{{author}}" 
    data-publishedDate="{{publishedDate}}"
    data-description="{{description}}"
    data-thumbnail="{{thumbnail}}"
    onclick="toggleFavorite(this)"
>
    <span class="favorite-active" style="{{^favorite}}display:none;{{/favorite}}">‚ù§Ô∏è</span>
    <span class="favorite-inactive" style="{{#favorite}}display:none;{{/favorite}}">ü§ç</span>
</span>
            {{/user}}
          </div>
        </div>
      {{/books}}
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Book Finder</p>
  </footer>

<script>
    async function toggleFavorite(element) {
        const title = element.getAttribute("data-title");
        const author = element.getAttribute("data-author");
        const publishedDate = element.getAttribute("data-publishedDate") || "N/A";
        const description = element.getAttribute("data-description") || "No description available";
        const thumbnail = element.getAttribute("data-thumbnail") || "";

        try {
            const response = await fetch("/favorites/toggle", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ title, author, publishedDate, description, thumbnail }),
            });

            if (!response.ok) {
          alert("‚ùå Neautorizovan√Ω p≈ô√≠stup. P≈ôihlaste se pros√≠m.");
          return;
        }

            const result = await response.json();

            const isFavorite = result.favorites.some(
                (book) => book.title === title && book.author === author
            );

            const activeHeart = element.querySelector(".favorite-active");
            const inactiveHeart = element.querySelector(".favorite-inactive");

            if (isFavorite) {
                activeHeart.style.display = "inline";
                inactiveHeart.style.display = "none";
                alert(`‚úÖ P≈ôid√°no do obl√≠ben√Ωch: "${title}"`);
            } else {
                activeHeart.style.display = "none";
                inactiveHeart.style.display = "inline";
                alert(`‚ùå Odebr√°no z obl√≠ben√Ωch: "${title}"`);
            }

            
        } catch (error) {
            alert("‚ùå Nastala chyba p≈ôi ukl√°d√°n√≠ do obl√≠ben√Ωch.");
        }
    }

    document.querySelector("#logoutButton")?.addEventListener("click", async function () {
        const response = await fetch("/auth/logout", { method: "GET" });

        if (response.ok) {
            alert("‚úÖ Odhl√°≈°en√≠ bylo √∫spƒõ≈°n√©.");
            window.location.href = "/auth/login";
        } else {
            alert("‚ùå Chyba p≈ôi odhla≈°ov√°n√≠.");
        }
    });
</script>

</body>
</html>
